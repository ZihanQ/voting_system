# 开发需求文档：简易投票系统后端

## 项目概述
该系统旨在为用户提供一个简单的投票平台，用户可以创建投票主题，其他用户可以参与投票并记录投票信息。系统将提供创建投票、查看投票主题、投票、查看投票结果等功能。

## 系统功能需求

### 1. 用户管理功能
#### 1.1 用户注册与登录
- 用户可以通过邮箱或用户名注册。
- 用户通过邮箱/用户名和密码登录。
- 使用 JWT（JSON Web Token）进行身份认证。
- 注册时需要验证邮箱地址。

#### 1.2 用户信息管理
- 用户可以查看、修改个人资料，如用户名、头像等。
- 用户可以查看自己参与过的投票记录。

### 2. 投票管理功能
#### 2.1 创建投票
- 用户可以创建新的投票主题，输入投票标题、描述以及投票选项。
- 每个投票可以设置是否允许匿名投票。
- 创建投票时可以设置投票的开始和结束时间。
- 系统保存投票的创建者信息。

#### 2.2 查看投票主题
- 用户可以查看所有投票主题列表，包括投票标题、创建者、投票时间等信息。
- 支持对投票进行筛选和排序（例如按时间排序）。

#### 2.3 投票参与
- 用户可以查看某个投票主题的详细信息，包括投票选项、剩余投票时间等。
- 用户可以对投票选项进行选择，完成投票。
- 投票后记录用户的投票行为，防止重复投票。
- 支持匿名投票模式时，投票者信息不记录。

#### 2.4 查看投票结果
- 用户可以查看自己参与的投票的实时投票结果。
- 投票结果显示为各个选项的投票数量及比例。

#### 2.5 投票结束与禁用投票
- 投票结束后，用户不能再进行投票。
- 系统自动关闭投票，并显示最终结果。

### 3. 数据管理功能
#### 3.1 投票记录
- 系统会记录每个用户的投票信息（包括投票主题、选项、投票时间等）。
- 用户只能对同一投票主题投票一次。

#### 3.2 投票选项统计
- 对每个投票主题的选项进行实时统计，并生成图表形式的结果。

#### 3.3 投票历史
- 用户可以查看自己参与过的投票历史记录。

### 4. 后台管理功能
#### 4.1 管理员权限
- 系统应该有管理员权限，管理员可以查看所有投票主题、用户信息和投票记录。
- 管理员可以禁用某个投票主题或删除某些投票。

#### 4.2 投票统计
- 后台应能够查看全站所有投票的统计信息。
- 管理员可以根据投票主题查看投票结果。

## 系统技术要求

### 1. 技术栈
- **后端框架**：Flask
- **数据库**：sqlite3（用于存储用户信息、投票主题、投票记录等）
- **认证方式**：JWT（JSON Web Token）
- **数据格式**：RESTful API，使用JSON格式交换数据
- **API文档**：使用Swagger进行API文档生成和管理
- **图表显示**：可以使用`matplotlib`或`Chart.js`来展示投票结果

### 2. 接口设计

#### 2.1 用户接口
- **POST /register**：用户注册
  - 请求参数：`username`, `password`, `email`
  - 返回值：注册成功/失败信息
- **POST /login**：用户登录
  - 请求参数：`username`, `password`
  - 返回值：JWT令牌
- **GET /user/profile**：查看用户信息（需要验证JWT）
  - 请求参数：无
  - 返回值：`username`, `email`, `avatar_url` 等信息
- **PUT /user/profile**：修改用户信息（需要验证JWT）
  - 请求参数：`username`, `email`, `avatar_url`
  - 返回值：修改结果

#### 2.2 投票接口
- **POST /poll**：创建投票主题（需要验证JWT）
  - 请求参数：`title`, `description`, `options` (投票选项), `start_time`, `end_time`
  - 返回值：投票创建结果
- **GET /polls**：获取所有投票列表
  - 请求参数：`page`, `size`（分页参数）
  - 返回值：投票列表（包含标题、创建者、投票时间等）
- **GET /poll/{poll_id}**：查看某个投票详情
  - 请求参数：`poll_id`
  - 返回值：投票主题详细信息，包括选项、投票人数等
- **POST /poll/{poll_id}/vote**：用户对某个投票选项进行投票（需要验证JWT）
  - 请求参数：`poll_id`, `selected_option`
  - 返回值：投票成功/失败信息
- **GET /poll/{poll_id}/results**：查看某个投票的实时结果
  - 请求参数：`poll_id`
  - 返回值：各选项的投票数量及比例

#### 2.3 管理员接口
- **GET /admin/polls**：查看所有投票列表（需要管理员权限）
  - 请求参数：`page`, `size`
  - 返回值：投票列表
- **DELETE /admin/poll/{poll_id}**：删除某个投票（需要管理员权限）
  - 请求参数：`poll_id`
  - 返回值：删除结果

### 3. 数据库设计
- **Users表**
  - id: INT, 主键，自增
  - username: VARCHAR(255), 唯一
  - email: VARCHAR(255), 唯一
  - password_hash: VARCHAR(255)
  - avatar_url: VARCHAR(255)
  
- **Polls表**
  - id: INT, 主键，自增
  - title: VARCHAR(255)
  - description: TEXT
  - start_time: DATETIME
  - end_time: DATETIME
  - creator_id: INT, 外键 (Users表)
  - is_active: BOOLEAN, 是否处于活跃状态
  
- **PollOptions表**
  - id: INT, 主键，自增
  - poll_id: INT, 外键 (Polls表)
  - option_text: VARCHAR(255)
  
- **Votes表**
  - id: INT, 主键，自增
  - user_id: INT, 外键 (Users表)
  - poll_id: INT, 外键 (Polls表)
  - option_id: INT, 外键 (PollOptions表)
  - vote_time: DATETIME
  
### 4. 安全性需求
- 所有敏感数据如密码应进行加密处理（使用bcrypt或PBKDF2）。
- 使用JWT进行身份认证和授权。
- 确保所有API端点的权限控制，确保只有授权用户可以进行特定操作。

## 非功能性需求

### 1. 性能
- 系统应能够支持并发请求，支持多用户同时操作。
- 对数据库查询进行优化，确保投票统计等操作的高效性。

### 2. 可扩展性
- 该系统设计要具有良好的可扩展性，便于未来增加更多功能，如投票选项的图片支持、投票主题的分类等。

### 3. 可维护性
- 代码结构清晰，采用模块化设计，确保易于维护和扩展。
- 采用单元测试和集成测试，确保代码质量。

### 4. 文档
- 提供完整的API文档，便于前端开发者与其他开发人员使用。

## 时间计划

| 阶段       | 任务描述                                | 时间安排     |
| ---------- | --------------------------------------- | ------------ |
| 需求分析   | 完成需求分析和设计文档                 | 2025-01-21   |
| 系统设计   | 完成系统架构设计与数据库设计           | 2025-01-28   |
| 开发实现   | 完成后端API实现和数据库操作            | 2025-02-28   |
| 测试与调试 | 完成单元测试、集成测试，调试系统       | 2025-03-10   |
| 上线部署   | 部署系统，进行用户测试和优化           | 2025-03-15   |

## 风险评估与应对

- **风险**：投票数据泄露或篡改。
  - **应对措施**：加强数据库的权限控制，使用加密存储用户敏感信息，确保API的安全性。

- **风险**：并发请求时数据库性能下降。
  - **应对措施**：优化数据库查询，增加缓存策略。

- **风险**：用户体验不佳。
  - **应对措施**：简化操作流程，提供清晰的界